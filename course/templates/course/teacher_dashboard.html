<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Course Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-6xl mx-auto py-12 px-4 sm:px-6 lg:px-8 bg-white shadow-lg rounded-lg">
        <h1 class="text-4xl font-bold text-center mb-10">Complete Course Dashboard</h1>

        <!-- Create Course Button -->
        <button class="bg-blue-500 text-white font-semibold py-2 px-4 rounded mb-8 hover:bg-blue-600" onclick="toggleCreateCourseForm()">Create New Course</button>

        <!-- Create Course Form -->
        <div class="hidden bg-gray-50 p-6 rounded-lg mb-6" id="create-course-form">
            <h3 class="text-2xl font-semibold mb-4">Create a New Course</h3>
            <input type="text" id="course-title" placeholder="Course Title" class="w-full p-3 mb-4 border border-gray-300 rounded" required>
            <textarea id="course-description" placeholder="Course Description" class="w-full p-3 mb-4 border border-gray-300 rounded" required></textarea>
            <input type="date" id="course-validation-date" class="w-full p-3 mb-4 border border-gray-300 rounded" required>
            <input type="number" id="course-price" placeholder="Price" step="0.01" class="w-full p-3 mb-4 border border-gray-300 rounded" required>
            <label for="course-thumbnail" class="block mb-2">Upload Thumbnail:</label>
            <input type="file" id="course-thumbnail" accept="image/*" class="w-full mb-4 p-2 border border-gray-300 rounded" required>
            <button class="bg-green-500 text-white font-semibold py-2 px-4 rounded hover:bg-green-600" onclick="submitCourseForm()">Create Course</button>
        </div>

        <!-- Profile Section -->
        <section id="profile" class="mb-10">
            <h2 class="text-3xl font-semibold text-center mb-6">Profile</h2>
            <p id="profile-loading" class="text-center text-gray-500">Loading profile...</p>
            <div id="profile-details" class="text-center hidden">
                <p><strong>Username:</strong> <span id="username"></span></p>
                <p><strong>Email:</strong> <span id="email"></span></p>
                <p><strong>Address:</strong> <span id="address"></span></p>
                <p><strong>Country:</strong> <span id="country"></span></p>
                <p><strong>Phone Number:</strong> <span id="phone_number"></span></p>
                <p><strong>Bio:</strong> <span id="bio"></span></p>
                <p><strong>Expertise:</strong> <span id="expertise"></span></p>
            </div>
        </section>

        <!-- Courses Section -->
        <section id="courses" class="mb-10">
            <h2 class="text-3xl font-semibold text-center mb-6">Courses</h2>
            <p id="courses-loading" class="text-center text-gray-500">Loading courses...</p>
            <div id="course-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </section>

        <!-- Create Video Form (hidden initially) -->
        <div class="hidden bg-gray-50 p-6 rounded-lg mb-6" id="create-video-form">
            <h3 class="text-2xl font-semibold mb-4">Create a New Video</h3>
            <input type="text" id="video-title" placeholder="Video Title" class="w-full p-3 mb-4 border border-gray-300 rounded" required>
            <input type="file" id="video-file" accept="video/*" class="w-full mb-4 p-2 border border-gray-300 rounded" required>
            <button class="bg-green-500 text-white font-semibold py-2 px-4 rounded hover:bg-green-600" onclick="submitVideoForm()">Create Video</button>
        </div>

        <!-- Payments Section -->
        <section id="payments">
            <h2 class="text-3xl font-semibold text-center mb-6">Payments</h2>
            <p id="payments-loading" class="text-center text-gray-500">Loading payments...</p>
            <div id="payment-list" class="text-center"></div>
        </section>
    </div>

    <script>
        let selectedCourseId = null;
        let selectedChapterId = null;

        document.addEventListener('DOMContentLoaded', fetchDashboardData);

        async function fetchDashboardData() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('You are not authenticated. Please log in.');
                window.location.replace('/login/');
                return;
            }

            try {
                toggleLoading('profile', true);
                toggleLoading('courses', true);
                toggleLoading('payments', true);

                const response = await fetch('{{ base_url }}/api/teacher-dashboard/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }

                const data = await response.json();

                // Profile
                toggleLoading('profile', false);
                document.getElementById('profile-details').classList.remove('hidden');
                document.getElementById('username').textContent = data.profile.username;
                document.getElementById('email').textContent = data.profile.email;
                document.getElementById('address').textContent = data.profile.address;
                document.getElementById('country').textContent = data.profile.country;
                document.getElementById('phone_number').textContent = data.profile.phone_number;
                document.getElementById('bio').textContent = data.profile.bio;
                document.getElementById('expertise').textContent = data.profile.expertise;

                // Courses
                toggleLoading('courses', false);
                const courseList = document.getElementById('course-list');
                courseList.innerHTML = '';  // Clear existing content
                data.courses.forEach(course => {
                    const courseItem = document.createElement('div');
                    courseItem.classList.add('bg-white', 'p-6', 'rounded-lg', 'shadow-lg', 'text-center');

                    const thumbnailUrl = course.thumbnail_url || 'https://via.placeholder.com/150';
                    courseItem.innerHTML = `
                        <img src="${thumbnailUrl}" alt="${course.title}" class="w-full h-48 object-cover rounded-lg mb-4">
                        <h3 class="text-xl font-semibold mb-2">${course.title}</h3>
                        <p class="text-gray-600 mb-4">${course.description}</p>
                        <p class="font-bold text-lg">$${course.price}</p>
                        <p class="text-gray-500 text-sm">Valid until: ${course.validation_date}</p>
                        <button class="bg-blue-500 text-white py-2 px-4 rounded mt-4 hover:bg-blue-600" onclick="toggleChapters(${course.id})">View Chapters</button>
                        <div class="chapter-list hidden mt-4" id="chapter-list-${course.id}"></div>
                    `;
                    courseList.appendChild(courseItem);

                    // Handle chapters
                    const chapterList = document.getElementById(`chapter-list-${course.id}`);
                    course.chapters.forEach(chapter => {
                        const chapterItem = document.createElement('div');
                        chapterItem.classList.add('bg-gray-50', 'p-4', 'rounded-lg', 'shadow-lg', 'mb-4');
                        chapterItem.innerHTML = `
                            <h4 class="text-lg font-semibold mb-2">${chapter.title}</h4>
                            <p class="text-gray-600 mb-2">${chapter.description}</p>
                            <button class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600" onclick="toggleVideos(${chapter.id})">View Videos</button>
                            <button class="bg-blue-500 text-white py-2 px-4 rounded ml-2 hover:bg-blue-600" onclick="toggleCreateVideoForm(${chapter.id})">Add Video</button>
                            <div class="video-list hidden mt-4" id="video-list-${chapter.id}"></div>
                        `;
                        chapterList.appendChild(chapterItem);

                        // Handle videos
                        const videoList = document.getElementById(`video-list-${chapter.id}`);
                        chapter.videos.forEach(video => {
                            const videoItem = document.createElement('div');
                            videoItem.classList.add('p-3', 'bg-white', 'shadow-lg', 'rounded-lg', 'mb-2');
                            videoItem.innerHTML = `
                                <a href="${video.full_video_url}" target="_blank" class="text-blue-500 hover:underline">${video.title}</a>
                                <button class="text-sm text-red-500 ml-2" onclick="deleteVideo(${video.id})">Delete</button>
                            `;
                            videoList.appendChild(videoItem);
                        });
                    });
                });

                // Payments
                toggleLoading('payments', false);
                const paymentList = document.getElementById('payment-list');
                data.payments.forEach(payment => {
                    const paymentItem = document.createElement('p');
                    paymentItem.classList.add('text-gray-600', 'mb-4');
                    paymentItem.innerHTML = `Transaction ID: ${payment.transaction_id}, Amount: $${payment.amount}, Status: ${payment.status}`;
                    paymentList.appendChild(paymentItem);
                });

            } catch (error) {
                alert('Failed to load data. Please try again later.');
            }
        }

        function toggleLoading(section, isLoading) {
            const loadingElement = document.getElementById(`${section}-loading`);
            loadingElement.style.display = isLoading ? 'block' : 'none';
        }

        // Toggle chapters visibility
        function toggleChapters(courseId) {
            const chapterList = document.getElementById(`chapter-list-${courseId}`);
            chapterList.classList.toggle('hidden');
        }

        // Toggle videos visibility
        function toggleVideos(chapterId) {
            const videoList = document.getElementById(`video-list-${chapterId}`);
            videoList.classList.toggle('hidden');
        }

        // Toggle Create Video Form visibility
        function toggleCreateVideoForm(chapterId) {
            selectedChapterId = chapterId;
            const form = document.getElementById('create-video-form');
            form.classList.toggle('hidden');
        }

        // Submit the Create Video Form
        async function submitVideoForm() {
            const title = document.getElementById('video-title').value;
            const videoFile = document.getElementById('video-file').files[0];

            const formData = new FormData();
            formData.append('title', title);
            formData.append('video_file', videoFile);
            formData.append('chapter_id', selectedChapterId);

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('{{ base_url }}/api/videos/create/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Failed to create video');
                }

                const newVideo = await response.json();
                alert('Video created successfully!');
                toggleCreateVideoForm(selectedChapterId);
                fetchDashboardData();

            } catch (error) {
                alert('Error creating video: ' + error.message);
            }
        }

        // Dummy functions for edit and delete actions
        function deleteVideo(videoId) {
            if (confirm('Are you sure you want to delete this video?')) {
                alert('Delete Video ' + videoId);
            }
        }

        function toggleCreateCourseForm() {
            const form = document.getElementById('create-course-form');
            form.classList.toggle('hidden');
        }

        async function submitCourseForm() {
            const title = document.getElementById('course-title').value;
            const description = document.getElementById('course-description').value;
            const validationDate = document.getElementById('course-validation-date').value;
            const price = parseFloat(document.getElementById('course-price').value);
            const thumbnail = document.getElementById('course-thumbnail').files[0];

            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', description);
            formData.append('validation_date', validationDate);
            formData.append('price', price);
            formData.append('thumbnail', thumbnail);

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('{{ base_url }}/api/courses/create/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Failed to create course');
                }

                const newCourse = await response.json();
                alert('Course created successfully!');
                toggleCreateCourseForm();
                fetchDashboardData();

            } catch (error) {
                alert('Error creating course: ' + error.message);
            }
        }
    </script>
</body>
</html>
